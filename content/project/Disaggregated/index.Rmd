## Preparing data for analysis

```{r}
library(readxl)
sample_data_1<- read_excel("C:/Users/hp/Downloads/sample_data_1_1_.xlsx")
```

## Exploring the data
```{r}
library(tidyverse)
library(dplyr)
library(haven)
```
Using glimpse form the dplyr package we are able to see how our data looks like.Also using head() and tail() e can see the first five rows and last 5 rows.

```{r}
glimpse(sample_data_1)
head(sample_data_1,5)
tail(sample_data_1,5)
```

Obtaining the summary to get the picture of our data

```{r}
summary(sample_data_1)
```

## Sample sizes for education subgroup

```{r}
sample_data_1 %>%
  group_by(v149) %>%
  summarise(n())
```

## Sample sizes and proportion of records for education subgroup

```{r}
sample_data_1 %>%
  group_by(v149) %>%
  summarise(n = n()) %>%
  mutate(p = n/sum(n))
```

## Constructing health indicators (skilled birth attendance)
```{r}
sample_data_1a <- sample_data_1 %>%
  mutate(sba =
           if_else(m3a == "yes"|
                   m3b == "yes"|
                   m3c == "yes"|
                   m3d == "yes",
                   1,0)
         )
```

# Tabulate *sba* variable (skilled birth attendance)
```{r}
count(sample_data_1a, sba)
```

# # Replacing missing values in *sba* with zeros and inspecting results
```{r}
sample_data_1b <- sample_data_1a %>%
  mutate(sba =
           if_else(m3a == "yes"|
                   m3b == "yes"|
                   m3c == "yes"|
                   m3d == "yes",
                   1,0,0)
         )
count(sample_data_1b, sba)
```

# Inspecting R objects
```{r}
sample_data_1b
head(sample_data_1b$sba , n = 10)
```

## Constructing inequality dimensions

# Mother's age categories (variable v012)
```{r}
summary(sample_data_1b$v012)
sample_data_1c <- sample_data_1b %>%
  mutate(mage =
           as.factor(case_when(
             v012 < 20 ~ '15-19 years',
             v012 >= 20 & v012 <= 34 ~ '20-34 years',
             v012 >= 35 & v012 <= 49 ~ '35-49 years')
           )
  )

levels(sample_data_1c$mage)

count(sample_data_1c, mage)
```

## Socioeconomic status (variable v190)
```{r}
sample_data_1d <- sample_data_1c %>%
  mutate(quintile =
           fct_recode(v190,
                      "Quintile 1 (poorest)" = "poorest",
                      "Quintile 2" = "poorer",
                      "Quintile 3" = "middle",
                      "Quintile 4" = "richer",
                      "Quintile 5 (richest)" = "richest")
  )

count(sample_data_1d, quintile)
```
## Mother's education (variable v149)
```{r}
count(sample_data_1d, v149)
sample_data_1e <- sample_data_1d %>%
  mutate(educatt =
           fct_recode(v149,
                      "No or primary education" = "no education",
                      "No or primary education" = "incomplete primary",
                      "No or primary education" = "complete primary",
                      "Secondary or higher education" = "incomplete secondary",
                      "Secondary or higher education" = "complete secondary",
                      "Secondary or higher education" = "higher")
  )

count(sample_data_1e, educatt)
```

## Place of residence (variable v025)

```{r}
sample_data_1f <- sample_data_1e %>%
  mutate(urban =
           fct_recode(v025,
                      "Urban" = "urban",
                      "Rural" = "rural")
  )

count(sample_data_1f, urban)
```
## Finalizing data object preparation by selecting specified variables

```{r}
sample_data_2 <- sample_data_1f %>%
  select(psu,
         weight,
         strata,
         sba,
         mage,
         quintile,
         educatt,
         urban)
```

## Calculating disaggregated estimates using R

```{r}
library(survey)
```

# Specifying complex survey design using svydesign() function
```{r}
sample_data_2_design <- svydesign(id = ~ psu,
                                  weights = ~ weight,
                                  strata = ~ strata,
                                  data = sample_data_2)

summary(sample_data_2_design)
```
## Calculating  national averages and corresponding confidence intervals using svymean

```{r}
svymean1 <- svymean(~ sba,
                    design = sample_data_2_design)

confint(svymean1)
```

# Calculating national averages and corresponding confidencce intervals using svyciprop

```{r}
svyciprop(~ sba,
          design = sample_data_2_design)
```

## Calculating disaggregated estimates for *sba* by wealth quintile
```{r}
svyby(~ sba,
      by = ~ quintile,
      design = sample_data_2_design,
      FUN = svymean,
      vartype = c("se", "ci"),
      keep.names = F)
```
## Calculating disaggregated estimates for *sba* by education level
```{r}
svyby(~ sba,
      by = ~ educatt,
      design = sample_data_2_design,
      FUN = svymean,
      vartype = c("se", "ci"),
      keep.names = F)
```
## Calculating disaggregated estimates for *sba* by place of residence
```{r}
svyby(~ sba,
      by = ~ urban,
      design = sample_data_2_design,
      FUN = svymean,
      vartype = c("se", "ci"),
      keep.names = F)
```
## Calculating disaggregated estimates for a specific subgroup (e.g. urban areas)
```{r}
urban_subset_design <- subset(sample_data_2_design, urban == 'Urban')

urban_subset_calc <- svyby(~ sba,
                           by = ~ urban,
                           design = urban_subset_design,
                           FUN = svymean,
                           vartype = c("se", "ci"),
                           keep.names = F)

urban_subset_calc
```
## Disaggregation by two dimensions of inequality (double disaggregation)
```{r}
svyby(~ sba,
      by = ~ urban + educatt,
      design = sample_data_2_design,
      FUN = svymean,
      vartype = c("se", "ci"),
      keep.names = F)
```
# Unweighted sample size
```{r}
nrow(sample_data_2)
```
# Unweighted sample sizes for dimension of inequality subgroups
```{r}
count(sample_data_2, quintile)
```
# National average weighted population sizes
```{r}
sample_data_2 <- sample_data_2 %>%
  mutate(size = 1)
```
```{r}
sample_data_2_design <- svydesign(id = ~ psu,
                                  weights = ~ weight,
                                  strata = ~ strata,
                                  data = sample_data_2)

svytotal(~ size,
         design = sample_data_2_design)
```
# Weighted population sizes for dimension of inequality subgroups
```{r}
sba_urban <- svyby(~ sba,
                   by = ~ urban,
                   design = sample_data_2_design,
                   FUN = svymean,
                   vartype = c("se", "ci")
                   )
```


## Creating a function to calculate disaggregated estimates for several dimensions of inequality
```{r}
svyby_disaggregated <- function(variables){
  svyby(~ sba,
        by = reformulate(variables),
        design = sample_data_2_design,
        FUN = svymean,
        vartype = c("se", "ci"),
        keep.names = F)
}
```
## Identify list of dimension of inequality variables
```{r}
variables <- c('urban', 'quintile', 'educatt', 'mage')
```

## Apply function svyby_disaggregated() to list of dimension of inequality variables
```{r}
lapply(variables, svyby_disaggregated)
```
